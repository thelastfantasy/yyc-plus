// ==UserScript==
// @name         Custom Chat Toolbar for yyc web
// @namespace    pikashi@gmail.com
// @version      0.1
// @description  脚本说明
// @author       pks
// @match        https://www.yyc.co.jp/my/mail_box/history/?id=*
// @match        https://www.yyc.co.jp/profile/*
// @require      https://cdn.jsdelivr.net/npm/jquery-hotkeys@0.2.2/jquery-hotkeys.min.js
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

const template = `挨拶メッセージです、GM_getValue()で値を取得、GM_setValueでセットするように今後改善します。`;

function main() {
    var $ = jQuery;
    jQuery.hotkeys.options.filterInputAcceptingElements = false;

    document.documentElement.appendChild(
        document.createElement('style')
    ).innerHTML = `
    #image-detail-cover {
      display: none;
    }
    `

    const titles = ["さん", "ちゃん", "様", "殿", "氏", "くん", "お嬢様", "嬢"];
    const editErea = '#mail_body';
    const targetId = $("#send_mail_btn").data("target-id");

    const toolbar = $('.mailoptions');
    const sayHiIcon = '<a id="sayHi" title="挨拶メール"><svg style="width: 24px; height: 24px;" t="1640487007297" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1424" width="200" height="200"><path d="M522.1376 936.6016c-21.2992 0-40.96-11.3664-51.5584-29.952l-46.7456-81.8176c-97.6384-18.0224-186.4704-63.0272-250.4192-126.976C106.496 631.0912 69.632 546.3552 69.632 459.3152c0-206.592 203.52-374.6816 453.6832-374.6816s453.6832 168.0896 453.6832 374.6816c0 177.3056-151.808 331.1616-361.4208 366.848l-40.7552 78.4384a59.2896 59.2896 0 0 1-51.5072 32h-1.1776z m1.1776-790.5792c-216.2688 0-392.2432 140.544-392.2432 313.2416 0 145.3568 128.8704 273.8688 306.3808 305.6128 16.1792 2.8672 30.0544 12.6464 38.0928 26.7264l46.4384 81.3056 40.6016-78.1312c7.8848-15.2064 22.8352-26.0096 39.936-28.7744 181.3504-29.7984 312.9856-158.8224 312.9856-306.7392 0.0512-172.6976-175.9232-313.2416-392.192-313.2416z" fill="#283033" p-id="1425"></path><path d="M687.9232 608.3584c-16.9472 0-30.72-13.7728-30.72-30.72v-140.288c0-16.9472 13.7728-30.72 30.72-30.72s30.72 13.7728 30.72 30.72v140.3392c0 16.9472-13.7728 30.6688-30.72 30.6688z" fill="#E92385" p-id="1426"></path><path d="M685.4144 339.6096m-37.376 0a37.376 37.376 0 1 0 74.752 0 37.376 37.376 0 1 0-74.752 0Z" fill="#E92385" p-id="1427"></path><path d="M540.3136 297.728c-16.9472 0-30.72 13.7728-30.72 30.72v96.6656c-1.3824-0.2048-2.7648-0.3072-4.1984-0.3072H400.128c-0.256 0-0.4608 0.0512-0.7168 0.0512V328.448c0-16.9472-13.7728-30.72-30.72-30.72s-30.72 13.7728-30.72 30.72v254.1056c0 16.9472 13.7728 30.72 30.72 30.72s30.72-13.7728 30.72-30.72V486.1952c0.256 0 0.4608 0.0512 0.7168 0.0512H505.344c1.4336 0 2.816-0.1536 4.1984-0.3072v96.6656c0 16.9472 13.7728 30.72 30.72 30.72s30.72-13.7728 30.72-30.72V328.448c0.0512-16.9984-13.7216-30.72-30.6688-30.72z" fill="#E92385" p-id="1428"></path></svg></a>';
    const userIcon = '<a id="insertUserName" title="{username}さんを入力 alt + i"><svg style="width: 24px; height: 24px;" t="1647659228569" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1388" width="200" height="200"><path d="M853.544779 594.445593c-32.931115-54.824779-53.148319-199.879363-63.777983-300.965381a3116.766018 3116.766018 0 0 1-9.17069-105.462938c0-92.123752-74.616071-166.739823-166.739823-166.739823h-208.424779c-92.123752 0-166.739823 74.616071-166.739823 166.739823 0 0-3.126372 48.562973-10.004389 113.174655-10.838088 100.460743-30.846867 239.688496-62.944283 293.244602-62.110584 103.804602 145.897345 177.161062 145.897345 177.161062s71.07285-37.090549 93.79115-62.527434v-66.270017c-77.950867-40.235044-125.054867-126.096991-125.054867-225.515611v-114.633628l229.267257-72.948673s159.861805-40.851257 229.267256 72.948673v114.633628c0 99.409558-47.104 185.289628-125.054867 225.515611v66.279079c22.718301 25.427823 93.79115 62.527434 93.791151 62.527434s208.007929-73.365522 145.897345-177.161062z" fill="#414042" p-id="1389"></path><path d="M905.650973 948.767717v52.106195H113.636814v-52.106195s1.250549-73.990796 104.21239-135.684531v0.208425c171.950442 0 119.844248 83.369912 291.79469 83.369911s119.844248-83.369912 291.79469-83.369911l0.41685-0.634337c103.37869 61.702796 103.79554 136.110442 103.795539 136.110443z" fill="#DC5B69" p-id="1390"></path><path d="M707.647434 771.606655c38.350159 12.088637 69.197027 26.261522 94.208 41.050619l-0.41685 0.634337c-171.950442 0-119.844248 83.369912-291.79469 83.369911s-119.844248-83.369912-291.79469-83.369911v-0.208425c24.802549-14.798159 55.649416-29.179469 93.79115-41.476531 0 0 71.07285-37.099611 93.79115-62.527434v-66.279079c30.430018 15.840283 65.445381 24.594124 104.21239 24.594123s73.782372-8.753841 104.212389-24.594123v66.279079c22.718301 25.427823 93.79115 62.527434 93.791151 62.527434z" fill="#FFE1B2" p-id="1391"></path><path d="M613.856283 642.800142c-30.430018 15.840283-65.445381 24.594124-104.212389 24.594123s-73.782372-8.753841-104.21239-24.594123c-77.950867-40.235044-125.054867-126.096991-125.054867-225.515611v-114.633628l229.267257-72.948673s159.861805-40.851257 229.267256 72.948673v114.633628c0 99.409558-47.104 185.289628-125.054867 225.515611z" fill="#FFE1B2" p-id="1392"></path><path d="M467.958938 344.335858v72.948673c0 11.463363-9.379115 20.842478-20.842478 20.842478h-83.369911a20.905912 20.905912 0 0 1-20.842478-20.842478v-72.948673h125.054867zM676.383717 344.335858v72.948673c0 11.463363-9.379115 20.842478-20.842478 20.842478h-83.369912a20.905912 20.905912 0 0 1-20.842477-20.842478v-72.948673h125.054867z" fill="#FFFFFF" p-id="1393"></path><path d="M809.820885 799.209345c-17.960779-10.620602-37.733947-20.244389-59.06577-28.798867 42.138053-19.900035 106.523186-57.561487 124.828319-108.30839 9.152566-25.364389 6.252743-50.82846-8.636036-75.712566-23.96885-39.89069-45.853451-144.492743-61.630301-294.513274a3167.367929 3167.367929 0 0 1-9.089132-104.393629C795.937982 87.175929 714.235469 5.645593 613.856283 5.645593h-208.424779C305.052319 5.645593 223.349805 87.175929 223.059823 187.491681c-0.344354 5.201558-3.516035 51.915894-9.91377 112.023788-15.73154 145.815788-37.335221 247.708319-60.814726 286.901239-14.879717 24.85692-17.77954 50.320991-8.626973 75.68538 18.350442 50.87377 82.998372 88.589593 125.127363 108.453381-21.295575 8.672283-41.059681 18.395752-59.02046 29.116035C100.660106 865.080637 98.059327 945.133876 98.004956 948.513982v68.00085h823.277876v-67.828673c-0.018124-3.39823-1.72177-83.977062-111.461947-149.467752z m-392.735717-79.717947l3.978195-4.440354V666.959292c27.475823 10.647788 57.162761 16.05777 88.580531 16.05777 31.426832 0 61.122832-5.409982 88.580531-16.05777v48.073628l3.978194 4.440354c23.92354 26.787115 100.741664 67.031221 100.741664 67.031222a499.313274 499.313274 0 0 1 41.059682 14.925026c-49.396673 7.331115-73.700814 24.222584-97.388744 40.706266-28.744496 19.999717-55.90315 38.875752-136.971327 38.875752-81.068177 0-108.226832-18.885097-136.971328-38.875752-23.59731-16.420248-47.80177-33.257345-96.854088-40.63377a503.300531 503.300531 0 0 1 40.615646-15.024708s76.727504-40.21692 100.651044-66.994974z m306.194124-349.102442h-31.263717v-41.684956h-156.318584v41.684956h-52.106195v-41.684956h-156.318584v41.684956h-31.263716v-56.310938l217.867327-69.323894c4.114124-0.97869 40.778761-9.315681 83.940814-5.600283 57.162761 4.911575 99.346124 27.783929 125.462655 68.000849v63.234266z m-62.527434-10.421239v57.316814a5.283115 5.283115 0 0 1-5.210619 5.210619h-83.369912a5.283115 5.283115 0 0 1-5.210619-5.210619v-57.316814h93.79115z m-208.424778 0v57.316814a5.283115 5.283115 0 0 1-5.21062 5.210619h-83.369911a5.283115 5.283115 0 0 1-5.21062-5.210619v-57.316814h93.791151z m-156.318584 41.684956h31.263716v15.631858a36.519646 36.519646 0 0 0 36.474337 36.474336h83.369911a36.519646 36.519646 0 0 0 36.474336-36.474336v-15.631858h52.106195v15.631858a36.519646 36.519646 0 0 0 36.474336 36.474336h83.369912a36.519646 36.519646 0 0 0 36.474336-36.474336v-15.631858h31.263717v15.631858c0 46.252177-10.838088 90.302301-31.345274 127.39285-20.362195 36.827752-49.840708 65.961912-85.291045 84.257982-29.106973 15.142513-61.739044 22.827044-96.999079 22.827044-35.260035 0-67.892106-7.684531-97.04439-22.85423-35.405027-18.268885-64.88354-47.393982-85.245734-84.230796-20.507186-37.090549-31.345274-81.140673-31.345274-127.39285v-15.631858zM173.10131 651.463363c-5.890265-16.320566-3.896637-32.35115 6.05338-48.979823 26.506195-44.240425 48.390796-145.045522 65.073841-299.642336a3065.683823 3065.683823 0 0 0 10.058761-113.818054l0.036248-1.005876c0-83.324602 67.783363-151.107965 151.107964-151.107964h208.424779c83.324602 0 151.107965 67.783363 151.107965 151.107964l0.036248 1.014938c0.027186 0.453097 3.008566 45.79908 9.225062 106.079151 11.490549 109.28708 32.260531 251.342159 65.907539 307.363115 9.95908 16.637735 11.934584 32.659257 6.053381 48.988885-17.426124 48.363611-99.772035 88.607717-137.379115 103.043398-20.797168-11.236814-61.122832-34.616637-79.319221-51.789026v-50.647222c37.14492-21.232142 68.073345-52.948956 89.803893-92.268743 23.062655-41.712142 35.250973-90.981947 35.250974-142.517239V298.255858l-2.283611-3.742584c-31.082478-50.973451-83.895504-80.923186-152.720991-86.586902-50.674407-4.186619-92.033133 6.18931-93.763965 6.633345l-241.029663 76.664071v126.051681c0 51.535292 12.188319 100.814159 35.250973 142.526301 21.739611 39.32885 52.677097 71.054726 89.803894 92.268743v50.647222c-18.187327 17.154265-58.449558 40.506903-79.255788 51.76184a465.566584 465.566584 0 0 1-58.802973-28.001416c-42.500531-24.240708-69.686372-50.176-78.639575-75.014796z m716.917805 333.77869H129.268673v-36.184354c0.081558-1.468035 1.214301-17.607363 12.759221-39.781947 19.356319-37.199292 53.320496-63.886726 79.835752-80.325097 77.932743 0.625274 104.692673 19.193204 132.956885 38.857628 31.444956 21.866478 63.941097 44.485097 154.823363 44.485098s123.387469-22.618619 154.823363-44.485098c28.400142-19.755044 55.277876-38.413593 134.062442-38.86669 45.944071 28.527009 68.32708 59.102018 79.065487 80.026053 11.563044 22.564248 12.378619 38.912 12.423929 39.963186v36.311221z" fill="#231F20" p-id="1394"></path><path d="M509.643894 516.286301h41.684956v-31.263717h-26.053098v-36.474336h-31.263717v52.106194c0 8.636035 6.995823 15.631858 15.631859 15.631859z" fill="#231F20" p-id="1395"></path></svg></a>';
    toolbar.append('<li>' + sayHiIcon + '</li>');
    toolbar.append('<li>' + userIcon + '</li>');
    toolbar.append('<div id="rightToolbar" style="position: absolute;right: 28px;"></div>');
    const rightToolbar = $('#rightToolbar');
    rightToolbar.append('<input id="nickname" style="display: inline-block;width: 80px;text-align: right;height: 18px;background: rgb(233, 233, 237);border-color: rgb(227, 227, 227);" type="text" placeholder="ニックネーム">&nbsp;');
    rightToolbar.append('<select id="titlesSelect" style="display: inline-block;width: 72px;text-align: right;height: 24px;"></select>');
    GM_setValue(targetId, GM_getValue(targetId) || { "title": titles[0], "userName": "" });
    $.each(titles, function (index, value) {
        $('#titlesSelect').append($('<option />', {
            value: value,
            text: value,
            selected: value === GM_getValue(targetId).title,
            style: "direction: rtl;"
        }));
    });
    $('#nickname').val(GM_getValue(targetId).userName || "");
    let userName = $('#nickname').val() || $('.bodyInner .arrow').text() || $('.bodyInner dt>strong').text();
    let title = $('#titlesSelect').val();
    $('#titlesSelect').change(() => {
        title = $('#titlesSelect').val();
        GM_setValue(targetId, { "title": title, "userName": GM_getValue(targetId).userName || "" });
    });
    $('#nickname').change(() => {
        userName = $('#nickname').val();
        if (userName) {
            GM_setValue(targetId, { "title": GM_getValue(targetId).title || "", "userName": userName });
        }
    });

    function sayHi() {
        if (!$(editErea).val().trim()) {
            $(editErea).val(template);
            return;
        }
        if (confirm('チャットボックスをクリアして挨拶メールを入力する、よろしいですか？'))
            $(editErea).val(template);
    }
    function insertUserName() {
        var myField = $(editErea)[0];
        var myValue = '{username}' + title;
        //IE support
        if (document.selection) {
            myField.focus();
            var sel = document.selection.createRange();
            sel.text = myValue;
        }
        //MOZILLA and others
        else if (myField.selectionStart || myField.selectionStart == '0') {
            var startPos = myField.selectionStart;
            var endPos = myField.selectionEnd;
            myField.value = myField.value.substring(0, startPos)
                + myValue
                + myField.value.substring(endPos, myField.value.length);
            myField.focus();
            myField.setSelectionRange(endPos + myValue.length - (endPos - startPos), endPos + myValue.length - (endPos - startPos));
        } else {
            myField.value += myValue;
            myField.focus();
            myField.setSelectionRange(myField.value.length, myField.value.length);
        }
    }
    function replaceTemplate() {
        var name = userName.replaceAll('さん', '');
        $(editErea).val($(editErea).val().trim().replaceAll('{username}', name).replaceAll('{title}', title));
    }
    $('#sayHi').click(sayHi);
    $('#insertUserName').click(insertUserName);
    $('#send_mail_form').submit(replaceTemplate);
    $(editErea).bind('keydown', 'alt+i', insertUserName);
    // your code here

}

(function () {
    'use strict';

    if (document.readyState == "complete" || document.readyState == "loaded" || document.readyState == "interactive") {
        main();
    } else {
        document.addEventListener("DOMContentLoaded", function (event) {
            main();
        });
    }

})();